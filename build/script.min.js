class AudioManager{constructor(){this.audioCtx=new(window.AudioContext||window.webkitAudioContext),this.oscillatorsTypes=["sine"],this.oscillatorsOptions=[["osc1","sine",1],["osc2","sine",1]],this.oscillators={},this.midNotes=[220,247,262,294,330,349,392,440],this.highNotes=[493,523,587,659,698,783,880],this.lowNotes=[110,123,130,146,164,174,195],this.blackNotes=[78,92,104,116,139,156,185,208,233,277,311,370,415,466,554,622,740],this.allNotes=this.blackNotes,this.noteOffset=1,this.timeoutDuration=150}initAudio(){for(var a=0;a<this.oscillatorsOptions.length;a++)this.initOscillators(this.oscillatorsOptions[a])}initOscillators(a){const b=this.audioCtx.createOscillator();b.volume=this.audioCtx.createGain(),b.volume.connect(this.audioCtx.destination),b.volume.gain.value=1,b.type=a[1],b.frequency.value=a[2],b.connect(b.volume),b.start();const c=a[0],d=new SimpleReverb(this.audioCtx,{seconds:4,decay:0,reverse:0});b.connect(d.input),d.connect(this.audioCtx.destination),b.timeout=null,this.oscillators[c]=b}getAverageNote(){let a=0;for(let b=0;b<this.allNotes.length;b++)a+=parseInt(this.allNotes[b],10);return a/this.allNotes.length}playNote(a,b=null,c=1){b||(b=this.getRandomFrequence()),a.frequency.setValueAtTime(b,this.audioCtx.currentTime),a.volume.gain.value=Math.min(c,1),a.timeout&&clearTimeout(a.timeout),a.timeout=setTimeout(()=>{a.frequency.setValueAtTime(0,this.audioCtx.currentTime)},this.timeoutDuration)}playNotes(){this.possibleFrequences=this.allNotes.slice(0);let a=0;for(let b in this.oscillators)setTimeout(()=>{let c=this.oscillators[b];const d=this.getRandomFrequence();let e=this.possibleFrequences.indexOf(d);-1<e&&this.possibleFrequences.splice(e,1),this.playNote(c,d,volume)},a*this.timeoutDuration),a++}getRandomFrequence(){const a=this.allNotes[Math.floor(Math.random()*this.allNotes.length)];return a}}class Monolith{constructor(a={}){this.class=this,this.geometry=a.geometry||new THREE.CubeGeometry(10,20,1,3,6,1),this.texture=a.texture||new THREE.TextureLoader().load("assets/img/black.jpg"),this.material=a.material||new THREE.ShaderMaterial({uniforms:{tMatCap:{type:"t",value:this.texture}},vertexShader:document.getElementById("sem-vs").textContent,fragmentShader:document.getElementById("sem-fs").textContent}),this.material.uniforms.tMatCap.value.wrapS=this.material.uniforms.tMatCap.value.wrapT=THREE.ClampToEdgeWrapping,this.mesh=new THREE.Mesh(this.geometry,this.material),this.position=a.position||{x:0,y:0,z:0},this.mesh.position.set(this.position.x,this.position.y,this.position.z),this.hoverable=!0,this.rotation={x:0,y:0,z:0},this.parent=new THREE.Object3D,this.parent.position.set(0,0,0),this.rotationSpeed=1*(1/this.position.z),this.parent.rotation.set(0,-a.angle,0),this.distance=a.distance||1,this.parent.add(this.mesh),this.osc=a.osc||audioManager.oscillators[0],this.note=a.note||audioManager.allNotes[0];let b=Math.min(...audioManager.allNotes),c=Math.max(...audioManager.allNotes);return this.volume=1-(this.note-b)/(c-b),this.isAnimating=!1,this}onClick(){}playAnimation(){this.isAnimating=!0,TweenMax.to(this.mesh.rotation,2,{z:this.mesh.rotation.z-Math.PI,ease:Elastic.easeOut.config(1),onComplete:()=>{setTimeout(()=>{this.isAnimating=!1},100)}})}update(a,b){this.parent.rotation.y+=this.rotationSpeed*b;let c=0.98<Math.sin(this.parent.rotation.y)||-0.98>Math.sin(this.parent.rotation.y),d=0.98<Math.sin(this.parent.rotation.y);d&&(audioManager.playNote(this.osc,this.note,this.volume),!this.isAnimating&&this.playAnimation())}}var colors=[[0,0,200],[200,0,0],[200,200,200],[200,200,200]],step=0,colorIndices=[0,1,2,3],gradientHolder=document.querySelector("#gradient"),gradientSpeed=2e-3;function updateGradient(){var a=colors[colorIndices[0]],b=colors[colorIndices[1]],c=colors[colorIndices[2]],d=colors[colorIndices[3]],e=1-step,f=Math.round(e*a[0]+step*b[0]),g=Math.round(e*a[1]+step*b[1]),k=Math.round(e*a[2]+step*b[2]),m="rgb("+f+","+g+","+k+")",n=Math.round(e*c[0]+step*d[0]),o=Math.round(e*c[1]+step*d[1]),p=Math.round(e*c[2]+step*d[2]),q="rgb("+n+","+o+","+p+")";gradientHolder.style.background="-webkit-gradient(linear, left top, right top, from("+m+"), to("+q+"))",gradientHolder.style.background="-webkit-gradient(linear, left top, right top, from("+m+"), to("+q+"))",gradientHolder.style.background="gradient(linear, left top, right top, from("+m+"), to("+q+"))",step+=gradientSpeed,1<=step&&(step%=1,colorIndices[0]=colorIndices[1],colorIndices[2]=colorIndices[3],colorIndices[1]=(colorIndices[1]+Math.floor(1+Math.random()*(colors.length-1)))%colors.length,colorIndices[3]=(colorIndices[3]+Math.floor(1+Math.random()*(colors.length-1)))%colors.length)}var renderer,canvas,camera,scene,rayCaster,mouseClickPosition,monoliths=[],monolithMeshes,clock,rotationX=rotationY=0,mouseOver=!1;const lerp=.03,lerp2=.1;let screenWidth,screenHeight,audioManager=null,meshesRotation=0,meshesRotationTarget=0,useOrbitControls=!0,zoomLevel=100,zoomMax=500,mouse={x:0.9,y:-0.05},averageNote=null,isClicking=!1,cameraTargetPosition={x:-1e3,y:63,z:1100},mouseOffset={x:0,y:0},originalMousePosition={x:0,y:0},mainMonolith=null,meshesRotationTargetLocked=!1;function init(){screenWidth=window.innerWidth,screenHeight=window.innerHeight,renderer=new THREE.WebGLRenderer({antialias:!0,alpha:!0,preserveDrawingBuffer:!0}),renderer.setSize(screenWidth,screenHeight),canvas=renderer.domElement,camera=new THREE.PerspectiveCamera(18,window.innerWidth/window.innerHeight,10,1e5),scene=new THREE.Scene,rayCaster=new THREE.Raycaster,mouseClickPosition=new THREE.Vector2,mouseOverPosition=new THREE.Vector2,clock=new THREE.Clock;var a=document.getElementById("container");a.appendChild(canvas),scene.add(camera),camera.position.x=-707,camera.position.y=-322,camera.position.z=909,monolithMeshes=new THREE.Object3D;var b=20,d=0.2,e=2*Math.PI/b;averageNote=audioManager.getAverageNote();for(let f=0;f<b;f++){let g={},k=0==f%2?0:1;g.osc=audioManager.oscillators[Object.keys(audioManager.oscillators)[k]],g.note=audioManager.getRandomFrequence();let m=50+500*Math.random();g.distance=m,g.angle=d,g.position={x:0,y:(g.note-averageNote)/2,z:Math.max(80,m*Math.sin(d))};let n=new Monolith(g);n.mesh.lookAt(new THREE.Vector3(0,g.position.y,0)),monoliths.push(n),monolithMeshes.add(n.parent),d+=e}scene.add(monolithMeshes),mainMonolith=new Monolith,mainMonolith.mesh.scale.set(10,10,10),scene.add(mainMonolith.mesh),controls=new THREE.OrbitControls(camera,renderer.domElement),controls.enableKeys=!1,controls.enableDamping=!0,controls.dampingFactor=0.25,controls.update()}function getClicked3DPoint(a){a.preventDefault(),mouseClickPosition.x=2*(a.clientX/canvas.width)-1,mouseClickPosition.y=2*-(a.clientY/canvas.height)+1,rayCaster.setFromCamera(mouseClickPosition,camera);var b=rayCaster.intersectObjects(scene.children,!0);if(0<b.length)if(b[0].object.uuid===mainMonolith.mesh.uuid){if(meshesRotationTargetLocked)return!1;meshesRotationTarget=0,meshesRotationTargetLocked=!0,TweenLite.to(mainMonolith.mesh.rotation,5,{z:mainMonolith.mesh.rotation.z-Math.PI,ease:Power4.easeInOut}),setTimeout(()=>{for(let c=0,d=monoliths.length;c<d;c++){const e=monoliths[c],f={note:e.note},g=audioManager.getRandomFrequence(),k=0.8,m=0.08*c;TweenLite.to(e.mesh.position,k,{y:(g-averageNote)/2,delay:m,ease:Elastic.easeInOut.config(1)}),TweenLite.to(f,k,{delay:m,note:g,ease:Elastic.easeInOut.config(1),onUpdate:()=>{audioManager.playNote(e.osc,f.note,0.2)},onComplete:()=>{e.note=g}})}},1e3),setTimeout(()=>{meshesRotationTargetLocked=!1},5e3)}else for(let e,c=0,d=b.length;c<d;c++){e=b[c];for(let f=0,g=monoliths.length;f<g;f++){const k=monoliths[f];if(k.mesh.uuid===e.object.uuid){const m={note:k.note},n=audioManager.getRandomFrequence();TweenLite.to(k.mesh.position,1,{y:(n-averageNote)/2,ease:Elastic.easeInOut.config(1)}),TweenLite.to(m,1,{note:n,ease:Elastic.easeInOut.config(1),onUpdate:()=>{audioManager.playNote(k.osc,m.note,0.2)},onComplete:()=>{k.note=n}})}}}}var button=document.querySelector(".overlay-button");button.addEventListener("click",go);function go(){document.body.classList.add("visible"),audioManager=new AudioManager,audioManager.initAudio(),init(),initEvents(),render(),button.removeEventListener("click",go)}function onWindowResize(){screenWidth=window.innerWidth,screenHeight=window.innerHeight,camera.aspect=screenWidth/screenHeight,camera.updateProjectionMatrix(),renderer.setSize(screenWidth,screenHeight)}function initEvents(){window.addEventListener("resize",onWindowResize,!1),canvas.addEventListener("click",c=>{getClicked3DPoint(c)}),canvas.addEventListener("mousedown",()=>{isClicking=!0,document.body.classList.add("grabbing"),mouse.x=2*(event.clientX/screenWidth-.5),mouse.y=2*(event.clientY/screenHeight-.5),originalMousePosition={x:mouse.x,y:mouse.y},mouseOffset.x=0,mouseOffset.y=0}),window.addEventListener("mousemove",function(c){mouse.x=2*(c.clientX/screenWidth-.5),mouse.y=2*(c.clientY/screenHeight-.5),cameraTargetPosition={x:10*zoomLevel*Math.cos(4*mouse.x),z:-10*zoomLevel*Math.sin(4*mouse.x),y:-700*mouse.y}}),canvas.addEventListener("mouseup",()=>{isClicking=!1,document.body.classList.remove("grabbing"),originalMousePosition={x:0,x:0},mouseOffset.x=0,mouseOffset.y=0}),document.addEventListener("keydown",c=>{38===c.keyCode&&(meshesRotationTarget+=10),40===c.keyCode&&(meshesRotationTarget-=10),32===c.keyCode&&(renderer.autoClear=!renderer.autoClear)}),document.addEventListener("mousewheel",c=>{return zoomLevel>zoomMax&&0<c.deltaY||zoomLevel<-zoomMax&&0>c.deltaY?!1:void(zoomLevel+=c.deltaY/4,cameraTargetPosition={x:10*zoomLevel*Math.cos(4*mouse.x),z:-10*zoomLevel*Math.sin(4*mouse.x),y:-700*mouse.y})});let a=document.querySelector(".button--add"),b=document.querySelector(".button--remove");a.addEventListener("click",()=>{let d={};d.osc=audioManager.oscillators[Object.keys(audioManager.oscillators)[0]],d.note=audioManager.getRandomFrequence();let f=50+500*Math.random(),g=Math.random();d.distance=f,d.angle=g;let k=(d.note-averageNote)/2;d.position={x:0,y:1e3,z:Math.max(80,f*Math.sin(g))};let m=new Monolith(d);m.mesh.lookAt(new THREE.Vector3(0,d.position.y,0)),monoliths.push(m),monolithMeshes.add(m.parent),TweenLite.to(m.mesh.position,1,{y:k,ease:Power4.easeOut,onUpdate:()=>{audioManager.playNote(m.osc,d.note-0.1*(k-m.mesh.position.y),0.2)}})}),b.addEventListener("click",()=>{let d=this.monoliths[0];d&&(this.monoliths.shift(),TweenLite.to(d.mesh.position,1,{y:-1e3,ease:Power1.easeIn,onComplete:()=>{d.parent.remove(d.mesh),monolithMeshes.remove(d.parent)}}))})}function render(){requestAnimationFrame(render),controls.update(),delta=clock.getDelta(),updateGradient();for(let b,a=0;a<monoliths.length;a++)b=monoliths[a],b.update(clock.elapsedTime,meshesRotation);meshesRotationTargetLocked||(meshesRotationTarget+=(1-meshesRotationTarget)*lerp),meshesRotation+=(meshesRotationTarget-meshesRotation)*lerp2,!useOrbitControls,camera.lookAt(scene.position),renderer.render(scene,camera)}